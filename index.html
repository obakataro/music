<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Analog/Digital Player</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --accent-color: #ff6b6b;
            --record-size: 280px;
            --transition-speed: 300ms;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden; /* „Çπ„ÇØ„É≠„Éº„É´Á¶ÅÊ≠¢ */
            height: 100vh;
            width: 100vw;
        }

        /* --- ÁîªÈù¢„É¨„Ç§„Ç¢„Ç¶„Éà (Ê®™‰∏¶„Å≥) --- */
        #app-container {
            display: flex;
            width: 200vw; /* 2ÁîªÈù¢ÂàÜ */
            height: 100%;
            transition: transform var(--transition-speed) ease-in-out;
            will-change: transform;
        }

        .screen {
            width: 100vw;
            height: 100%;
            position: relative;
            flex-shrink: 0;
            overflow: hidden;
        }

        /* --- 3.1 „É¨„Ç≥„Éº„ÉâÁîªÈù¢ (Ë°®) --- */
        #record-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #2a2a2a 0%, #111 100%);
        }

        /* „É¨„Ç≥„Éº„ÉâÁõ§ */
        .record-wrapper {
            position: relative;
            width: var(--record-size);
            height: var(--record-size);
            margin-bottom: 40px;
        }

        .record-disc {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: repeating-radial-gradient(#111, #111 2px, #222 3px, #222 4px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: transform 1s ease-out; /* ÂÅúÊ≠¢ÊôÇ„ÅÆÊÖ£ÊÄßÁî® */
        }

        /* ÂõûËª¢„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .record-disc.spinning {
            animation: spin 3s linear infinite;
        }
        
        .record-disc.paused {
            animation-play-state: paused;
        }

        /* „É¨„Ç≥„Éº„Éâ„É©„Éô„É´ */
        .record-label {
            width: 35%;
            height: 35%;
            background: var(--accent-color);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
            color: #fff;
            overflow: hidden;
        }
        .label-text { font-size: 10px; opacity: 0.9; }
        .label-title { font-weight: bold; font-size: 12px; margin-bottom: 2px; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* „Éà„Éº„É≥„Ç¢„Éº„É† */
        .tone-arm {
            position: absolute;
            top: -20px;
            right: -20px;
            width: 20px;
            height: 200px;
            background-color: #888;
            transform-origin: top center;
            transform: rotate(-30deg); /* ÂàùÊúü‰ΩçÁΩÆ */
            transition: transform 0.5s linear;
            z-index: 10;
            pointer-events: none;
        }
        .tone-arm::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -5px;
            width: 30px;
            height: 40px;
            background-color: #444;
            border-radius: 4px;
        }

        /* Êìç‰ΩúUI */
        .controls {
            display: flex;
            gap: 30px;
            align-items: center;
            z-index: 20;
        }
        button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
        }
        button:active { transform: scale(0.95); }
        .play-btn { font-size: 40px; }

        .menu-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            z-index: 30;
        }

        /* --- 3.2 „É°„Éã„É•„ÉºÁîªÈù¢ (Ë£è) --- */
        #menu-view {
            background-color: #fff;
            color: #333;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .menu-header h2 { margin: 0; font-size: 20px; }
        .back-btn { color: #333; font-size: 24px; }

        /* „É©„Ç§„Éñ„É©„É™„É™„Çπ„Éà */
        .song-list { list-style: none; padding: 0; margin: 0; }
        .song-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .song-info { display: flex; flex-direction: column; }
        .song-title { font-weight: bold; font-size: 16px; }
        .song-artist { font-size: 12px; color: #666; }
        .delete-btn { color: #ff6b6b; font-size: 14px; margin-left: 10px; }

        /* „Éï„Ç°„Ç§„É´ËøΩÂä†„Ç®„É™„Ç¢ */
        .importer {
            margin-top: 20px;
            padding: 20px;
            border: 2px dashed #ccc;
            text-align: center;
            border-radius: 8px;
            color: #666;
        }
        
        /* „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫ */
        #db-status { font-size: 12px; color: #888; margin-top: auto; padding-top: 20px; }

        /* --- „Çπ„É©„Ç§„ÉâÂãï‰Ωú --- */
        /* „É°„Éã„É•„Éº„Ç™„Éº„Éó„É≥ÊôÇ: „Ç≥„É≥„ÉÜ„ÉäÂÖ®‰Ωì„ÇíÂ∑¶„Å´„Çπ„É©„Ç§„Éâ */
        body.menu-open #app-container {
            transform: translateX(-100vw);
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="record-view" class="screen">
        <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
        
        <div class="record-wrapper">
            <div class="tone-arm" id="toneArm"></div>
            <div class="record-disc" id="recordDisc">
                <div class="record-label">
                    <span class="label-title" id="lblTitle">No Audio</span>
                    <span class="label-text" id="lblArtist">-</span>
                </div>
            </div>
        </div>

        <div class="controls">
            <button onclick="prevSong()">‚èÆ</button>
            <button class="play-btn" onclick="togglePlay()" id="playBtn">‚ñ∂</button>
            <button onclick="nextSong()">‚è≠</button>
        </div>
    </div>

    <div id="menu-view" class="screen">
        <div class="menu-header">
            <h2>Library</h2>
            <button class="back-btn" onclick="toggleMenu()">‚úï</button>
        </div>

        <ul class="song-list" id="libraryList">
            </ul>

        <div class="importer" onclick="document.getElementById('fileInput').click()">
            + Import Music (MP3/WAV)
            <input type="file" id="fileInput" accept="audio/*" multiple style="display:none" onchange="importFiles(this)">
        </div>

        <div id="db-status">Using IndexedDB</div>
    </div>
</div>

<script>
    // --- 5. Data & State Management ---
    const DB_NAME = 'AnalogPlayerDB';
    const DB_VERSION = 1;
    let db;
    let audio = new Audio();
    let playlist = []; // ÁèæÂú®„ÅÆÂÜçÁîü„Ç≠„É•„Éº
    let currentIndex = -1;
    let isPlaying = false;
    let animationFrame;

    // --- IndexedDB Setup ---
    function initDB() {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains('songs')) {
                const store = db.createObjectStore('songs', { keyPath: 'id', autoIncrement: true });
                store.createIndex('title', 'title', { unique: false });
            }
        };

        request.onsuccess = (e) => {
            db = e.target.result;
            loadLibrary();
        };

        request.onerror = (e) => console.error("DB Error", e);
    }

    // --- File Import ---
    async function importFiles(input) {
        if (!input.files.length) return;

        // „É°„Çø„Éá„Éº„ÇøËß£Êûê„ÅØÁ∞°ÊòìÁöÑ„Å´„Éï„Ç°„Ç§„É´Âêç„Çí‰ΩøÁî® (Êú¨Êù•„ÅØjsmediatagsÁ≠â„Çí‰Ωø„ÅÜ)
        for (let file of input.files) {
            const tx = db.transaction(['songs'], 'readwrite');
            const store = tx.objectStore('songs');
            
            // „Éï„Ç°„Ç§„É´Âêç„Åã„ÇâArtist - Title„ÇíÊé®Ê∏¨„ÄÅ„Å™„Åë„Çå„Å∞„Éï„Ç°„Ç§„É´Âêç„ÅÆ„Åø
            let title = file.name.replace(/\.[^/.]+$/, "");
            let artist = "Unknown Artist";
            
            if (title.includes('-')) {
                const parts = title.split('-');
                artist = parts[0].trim();
                title = parts.slice(1).join('-').trim();
            }

            const songData = {
                title: title,
                artist: artist,
                blob: file,
                addedAt: new Date()
            };

            store.add(songData);
        }
        
        input.value = ''; // „É™„Çª„ÉÉ„Éà
        setTimeout(loadLibrary, 500); // Â∞ë„ÅóÂæÖ„Å£„Å¶„É™„É≠„Éº„Éâ
    }

    // --- Library UI ---
    function loadLibrary() {
        const tx = db.transaction(['songs'], 'readonly');
        const store = tx.objectStore('songs');
        const request = store.getAll();

        request.onsuccess = () => {
            const songs = request.result;
            const listEl = document.getElementById('libraryList');
            listEl.innerHTML = '';
            
            // „Éó„É¨„Ç§„É™„Çπ„ÉàÊõ¥Êñ∞
            playlist = songs;

            songs.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = 'song-item';
                li.innerHTML = `
                    <div class="song-info" onclick="playSongAtIndex(${index})">
                        <span class="song-title">${song.title}</span>
                        <span class="song-artist">${song.artist}</span>
                    </div>
                    <button class="delete-btn" onclick="deleteSong(${song.id})">üóë</button>
                `;
                listEl.appendChild(li);
            });

            updateStorageInfo();
        };
    }

    function deleteSong(id) {
        if(!confirm("ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
        const tx = db.transaction(['songs'], 'readwrite');
        tx.objectStore('songs').delete(id);
        tx.oncomplete = () => loadLibrary();
    }

    // --- Playback Logic ---
    function playSongAtIndex(index) {
        if (index < 0 || index >= playlist.length) return;
        
        currentIndex = index;
        const song = playlist[currentIndex];
        
        // Blob„Åã„ÇâURLÁîüÊàê
        const url = URL.createObjectURL(song.blob);
        audio.src = url;
        audio.play();
        
        // UIÊõ¥Êñ∞
        document.getElementById('lblTitle').textContent = song.title;
        document.getElementById('lblArtist').textContent = song.artist;
        updatePlayState(true);
        
        // „É°„Éã„É•„Éº„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Åü„ÇâÈñâ„Åò„Çã
        document.body.classList.remove('menu-open');
    }

    function togglePlay() {
        if (!audio.src) {
            if (playlist.length > 0) playSongAtIndex(0);
            return;
        }

        if (audio.paused) {
            audio.play();
            updatePlayState(true);
        } else {
            audio.pause();
            updatePlayState(false);
        }
    }

    function prevSong() {
        if (currentIndex > 0) playSongAtIndex(currentIndex - 1);
    }

    function nextSong() {
        if (currentIndex < playlist.length - 1) playSongAtIndex(currentIndex + 1);
    }

    // --- UI & Animation ---
    function updatePlayState(playing) {
        isPlaying = playing;
        const disc = document.getElementById('recordDisc');
        const btn = document.getElementById('playBtn');

        if (playing) {
            disc.classList.add('spinning');
            disc.classList.remove('paused');
            btn.textContent = '‚è∏';
            startArmTracking();
        } else {
            disc.classList.add('paused');
            // ÂÆåÂÖ®„Å´ÂÅúÊ≠¢„Åï„Åõ„Åö„ÄÅCSS„ÅÆtransition„ÅßÊÉ∞ÊÄß„Å£„ÅΩ„ÅèË¶ã„Åõ„Çã
            btn.textContent = '‚ñ∂';
            stopArmTracking();
        }
    }

    // „Éà„Éº„É≥„Ç¢„Éº„É†Âà∂Âæ°
    function startArmTracking() {
        const arm = document.getElementById('toneArm');
        
        function update() {
            if (!audio.paused && !audio.ended && audio.duration) {
                // ÂÜçÁîü‰ΩçÁΩÆ„Å´Âøú„Åò„Å¶ËßíÂ∫¶Ë®àÁÆó (‰æã: 0% -> -30deg, 100% -> 15deg)
                const progress = audio.currentTime / audio.duration;
                const startAngle = -30;
                const endAngle = 15;
                const currentAngle = startAngle + (endAngle - startAngle) * progress;
                
                arm.style.transform = `rotate(${currentAngle}deg)`;
                animationFrame = requestAnimationFrame(update);
            }
        }
        cancelAnimationFrame(animationFrame);
        update();
    }

    function stopArmTracking() {
        cancelAnimationFrame(animationFrame);
    }
    
    // Êõ≤ÁµÇ‰∫ÜÊôÇ„ÅÆÂá¶ÁêÜ
    audio.onended = () => {
        updatePlayState(false);
        // „Éà„Éº„É≥„Ç¢„Éº„É†„ÇíÊàª„Åô
        document.getElementById('toneArm').style.transform = `rotate(-30deg)`;
        nextSong(); // Ëá™Âãï„ÅßÊ¨°„Å∏
    };

    // --- Menu Interaction ---
    function toggleMenu() {
        document.body.classList.toggle('menu-open');
    }

    function updateStorageInfo() {
        if (navigator.storage && navigator.storage.estimate) {
            navigator.storage.estimate().then(estimate => {
                const usageMB = (estimate.usage / 1024 / 1024).toFixed(1);
                document.getElementById('db-status').textContent = `DB Usage: ${usageMB} MB`;
            });
        }
    }

    // --- Initial Load ---
    window.onload = initDB;

</script>
</body>
</html>
